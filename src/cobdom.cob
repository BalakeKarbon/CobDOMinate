000100 IDENTIFICATION DIVISION.
000200 PROGRAM-ID. COBDOM.
000300 ENVIRONMENT DIVISION.
000400 CONFIGURATION SECTION.
000500 SOURCE-COMPUTER. UNIX-LINUX.
000600 OBJECT-COMPUTER. WASM.
000700 INPUT-OUTPUT SECTION.
000800 FILE-CONTROL.
000900 DATA DIVISION.
001000 FILE SECTION.
001100 WORKING-STORAGE SECTION.
001200 COPY './data/js.cpy'.
001300 01 WS-GENERIC PIC X(256).
001400 01 WS-TMP PIC X(30) 
001500   VALUE "() => 'Hello from inline JS!'" & X"00".
001600 LINKAGE SECTION.
001700 01 LS-VERSION PIC 99V99.
001800 01 LS-ELEMENT-VARIABLE PIC X(128).
001900 01 LS-ELEMENT-TYPE PIC X(128).
002000 01 LS-PARENT PIC X(128).
002100 01 LS-RETURN PIC S9.
002200 01 LS-RESULT PIC X(256).
002300 01 LS-HTML PIC X(256).
002400 01 LS-FUNCTION PIC X(64).
002500 01 LS-GENERIC PIC X(256).
002600*TO-DO: You dont need all of these only the max number of arguments for a
002700*function number of storage areas are required.
002800 PROCEDURE DIVISION.
002900 COBDOM-INIT SECTION.
003000*ENTRY 'COBDOM-INIT' USING LS-RETURN.
003100*  CALL 'emscripten_run_script_int' USING BY REFERENCE 
003200*  WS-COB-INIT RETURNING LS-RETURN.
003300 COBDOM-VERSION SECTION.
003400 ENTRY 'COBDOM-VERSION' USING BY REFERENCE LS-VERSION.
003500*I think by reference is redundant here.
003600   MOVE .01 TO LS-VERSION.
003700   MOVE WS-TMP TO WS-JS-COMMAND.
003800   CALL 'return_string' USING BY REFERENCE WS-GENERIC,
003900     WS-JS-COMMAND RETURNING LS-RETURN.
004000*Someone in this new section is causing a heap error.
004100   DISPLAY 'STRING ' WS-GENERIC.
004200   DISPLAY 'RESULT ' LS-RETURN.
004300*  CALL 'emscripten_run_script_int' USING BY CONTENT WS-JS-TEST.
004400*  MOVE FUNCTION TRIM('div', TRAILING) TO WS-ELEMENT-TYPE.
004500*  DISPLAY WS-ELEMENT-TYPE '.'.
004600   GOBACK.
004700 COBDOM-CREATE-ELEMENT SECTION.
004800 ENTRY 'COBDOM-CREATE-ELEMENT' USING BY 
004900   REFERENCE LS-RETURN, LS-ELEMENT-VARIABLE,
005000   LS-ELEMENT-TYPE.
005100   STRING 
005200     PART-A OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
005300     LS-ELEMENT-VARIABLE
005400     PART-A OF CREATE-ELEMENT OF WS-JS-COMMANDS
005500     LS-ELEMENT-TYPE
005600     PART-B OF CREATE-ELEMENT OF WS-JS-COMMANDS DELIMITED BY SPACE
005700     PART-B OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
005800     WS-NULL-BYTE DELIMITED BY SIZE
005900*The null byte is needed because were passing C strings to
006000*emscripten's API.
006100   INTO WS-JS-COMMAND END-STRING.
006200   CALL 'emscripten_run_script_int' USING BY REFERENCE
006300     WS-JS-COMMAND RETURNING LS-RETURN.
006400   GOBACK.
006500 COBDOM-APPEND-CHILD SECTION.
006600 ENTRY 'COBDOM-APPEND-CHILD' USING BY REFERENCE
006700   LS-RETURN, LS-ELEMENT-VARIABLE, LS-PARENT.
006800   STRING
006900     PART-A OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
007000     LS-PARENT
007100     PART-A OF APPEND-CHILD OF WS-JS-COMMANDS
007200     LS-ELEMENT-VARIABLE DELIMITED BY SPACE
007300     WS-END-PARENTHESIS DELIMITED BY SIZE
007400     PART-B OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
007500     WS-NULL-BYTE DELIMITED BY SIZE
007600   INTO WS-JS-COMMAND END-STRING.
007700   CALL 'emscripten_run_script_int' USING BY REFERENCE
007800     WS-JS-COMMAND RETURNING LS-RETURN.
007900   GOBACK.
008000 COBDOM-REMOVE-CHILD SECTION.
008100 ENTRY 'COBDOM-REMOVE-CHILD' USING BY REFERENCE
008200   LS-ELEMENT-VARIABLE, LS-RETURN, LS-PARENT.
008300   STRING
008400     PART-A OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
008500     LS-PARENT
008600     PART-A OF REMOVE-CHILD OF WS-JS-COMMANDS
008700     LS-ELEMENT-VARIABLE DELIMITED BY SPACE
008800     WS-END-PARENTHESIS DELIMITED BY SIZE
008900     PART-B OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
009000     WS-NULL-BYTE DELIMITED BY SIZE
009100   INTO WS-JS-COMMAND END-STRING.
009200   CALL 'emscripten_run_script_int' USING BY REFERENCE 
009300     WS-JS-COMMAND RETURNING LS-RETURN.
009400   GOBACK.
009500*Correct all of the above function delimiters.
009600 COBDOM-INNER-HTML SECTION.
009700 ENTRY 'COBDOM-INNER-HTML' USING BY REFERENCE
009800   LS-RETURN, LS-ELEMENT-VARIABLE, LS-HTML.
009900   STRING
010000     PART-A OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
010100     LS-ELEMENT-VARIABLE DELIMITED BY SPACE
010200     PART-A OF INNER-HTML OF WS-JS-COMMANDS DELIMITED BY SIZE
010300     LS-HTML DELIMITED BY WS-NULL-BYTE
010400     WS-DOUBLE-QUOTE DELIMITED BY SIZE
010500     PART-B OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
010600     WS-NULL-BYTE DELIMITED BY SIZE
010700   INTO WS-JS-COMMAND END-STRING.
010800   CALL 'emscripten_run_script_int' USING BY REFERENCE 
010900     WS-JS-COMMAND RETURNING LS-RETURN.
011000   GOBACK.
011100*TO-DO: Practically uplicate the above to make a textContent
011200*procedure.
011300 COBDOM-ADD-EVENT-LISTENER SECTION.
011400 ENTRY 'COBDOM-ADD-EVENT-LISTENER' USING BY REFERENCE
011500   LS-RETURN, LS-ELEMENT-VARIABLE, LS-ELEMENT-TYPE, 
011600   LS-FUNCTION.
011700   STRING
011800     PART-A OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
011900     LS-ELEMENT-VARIABLE DELIMITED BY SPACE
012000     PART-A OF ADD-EVENT-LISTENER OF WS-JS-COMMANDS 
012100     DELIMITED BY SIZE
012200     LS-ELEMENT-TYPE DELIMITED BY SPACE
012300     PART-B OF ADD-EVENT-LISTENER OF WS-JS-COMMANDS 
012400     DELIMITED BY SIZE
012500     LS-FUNCTION DELIMITED BY WS-NULL-BYTE
012600*    WS-END-PARENTHESIS DELIMITED BY SIZE
012700     PART-B OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
012800     WS-NULL-BYTE DELIMITED BY SIZE
012900   INTO WS-JS-COMMAND END-STRING.
013000   CALL 'emscripten_run_script_int' USING BY REFERENCE 
013100     WS-JS-COMMAND RETURNING LS-RETURN.
013200   GOBACK.
013300*TO-DO: Add a paragraph for setting class name, setting style,
013400*and perhaps setting the overall page style code/maybe set
013500*style by class name?
013600 COBDOM-CLASS-NAME SECTION.
013700 ENTRY 'COBDOM-CLASS-NAME' USING BY REFERENCE LS-RETURN,
013800   LS-ELEMENT-VARIABLE, LS-GENERIC.
013900   STRING
014000     PART-A OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
014100     LS-ELEMENT-VARIABLE DELIMITED BY SPACE
014200     PART-A OF CLASS-NAME OF WS-JS-COMMANDS DELIMITED BY SIZE
014300     LS-GENERIC DELIMITED BY SPACE
014400     WS-DOUBLE-QUOTE DELIMITED BY SIZE
014500     PART-B OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
014600     WS-NULL-BYTE DELIMITED BY SIZE
014700   INTO WS-JS-COMMAND END-STRING.
014800   CALL 'emscripten_run_script_int' USING BY REFERENCE 
014900     WS-JS-COMMAND RETURNING LS-RETURN.
015000   GOBACK.
015100 COBDOM-STYLE SECTION.
015200 ENTRY 'COBDOM-STYLE' USING BY REFERENCE LS-RETURN,
015300   LS-ELEMENT-VARIABLE, LS-GENERIC.
015400   STRING
015500     PART-A OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
015600     LS-ELEMENT-VARIABLE DELIMITED BY SPACE
015700     PART-A OF STYLE OF WS-JS-COMMANDS DELIMITED BY SIZE
015800     LS-GENERIC DELIMITED BY WS-NULL-BYTE
015900     PART-B OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
016000     WS-NULL-BYTE DELIMITED BY SIZE
016100   INTO WS-JS-COMMAND END-STRING.
016200   CALL 'emscripten_run_script_int' USING BY REFERENCE 
016300     WS-JS-COMMAND RETURNING LS-RETURN.
016400   GOBACK.
016500*TO-DO: Implement a get and set variable here. Make sure to check for
016600*reserved varnames in the set maybe.
016700*TO-DO: Implement cookie's and post requests ETC.
016800 COBDOM-SET-COOKIE SECTION.
016900 ENTRY 'COBDOM-SET-COOKIE' USING BY REFERENCE LS-RETURN,
017000   LS-ELEMENT-VARIABLE, LS-GENERIC.
017100*Here we use LS-ELEMENT-VARIABLE even though it is a cookie key.
017200   STRING
017300     PART-A OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
017400     PART-A OF SET-COOKIE OF WS-JS-COMMANDS DELIMITED BY SIZE
017500     LS-ELEMENT-VARIABLE DELIMITED BY SPACE
017600     WS-EQUALS DELIMITED BY SIZE
017700     WS-DOUBLE-QUOTE DELIMITED BY SIZE
017800     PART-B OF SET-COOKIE OF WS-JS-COMMANDS DELIMITED BY SIZE
017900     WS-DOUBLE-QUOTE DELIMITED BY SIZE
018000     LS-GENERIC DELIMITED BY WS-NULL-BYTE
018100     WS-DOUBLE-QUOTE DELIMITED BY SIZE
018200     WS-END-PARENTHESIS DELIMITED BY SIZE
018300     PART-B OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
018400     WS-NULL-BYTE DELIMITED BY SIZE
018500   INTO WS-JS-COMMAND END-STRING.
018600   CALL 'emscripten_run_script_int' USING BY REFERENCE 
018700     WS-JS-COMMAND RETURNING LS-RETURN.
018800   GOBACK.
018900 COBDOM-GET-COOKIE SECTION.
019000 ENTRY 'COBDOM-GET-COOKIE' USING BY REFERENCE LS-RETURN,
019100   LS-ELEMENT-VARIABLE, LS-RESULT.
019200*Here we use LS-ELEMENT-VARIABLE even though it is a cookie key.
019300*  STRING
019400*    PART-A OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
019500*    PART-B OF STATUS-WRAPPER OF WS-JS-COMMANDS DELIMITED BY SIZE
019600*    WS-NULL-BYTE DELIMITED BY SIZE
019700*  INTO WS-JS-COMMAND END-STRING.
019800*  CALL 'emscripten_run_script_int' USING BY REFERENCE 
019900*    WS-JS-COMMAND RETURNING LS-RETURN.
020000   GOBACK.
020100 
020200*This will have to be done by wrapping scripts into a function
020300*with a try catch statement or something of the sort.
020400*COBDOM-INNER-HTML SECTION.
020500*ENTRY 'COBDOM-INNER-HTML' USING
020600*So here this gets crazy, since we are using eval, we can return
020700*the variable name, or we could store the objects in a structure
020800*and return its key/index, or we could create and add it relying
020900*only on the id.
